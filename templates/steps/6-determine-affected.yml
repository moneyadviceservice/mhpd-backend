parameters:
  - name: target_branch
    type: string
  - name: compareWithTargetBranch
    type: boolean

steps:
  - template: ./1-checkout-main.yml
  - template: ./install-node-js.yml
  - template: ./2-install-dependencies.yml

  - script: |
      cd $(Build.SourcesDirectory)

      echo "Logging in to Azure..."
      az login --service-principal --username $(AKS_SPN_ID) --password $(AKS_SPN_KEY) --tenant $(TENANT_ID)
      echo "Running npx nx affected:build"
      if [ ${{ parameters.compareWithTargetBranch }} == true ]; then
        affected=$(npx nx affected:build --base=origin/${{ parameters.target_branch }})
      else
        affected=$(npx nx affected:build --target=build --base=HEAD~1 --head=HEAD)
      fi

      echo "Affected Projects: $affected"

      if echo "$affected" | grep -q "No projects with target build"; then
        echo "No affected projects. Exiting step."
        stepoutput=""
        echo "##vso[task.setvariable variable=envstodeploy;isOutput=true]$stepoutput"
        exit 0
      fi

      echo "Extracting list of affected projects..."
      projects=$(echo "$affected" | grep "^    - " | sed 's/^    - //')

      echo "Formatting output..."
      stepoutput=$(IFS=,; echo "${projects[*]}")
      stepoutput=$(echo $stepoutput | tr ' ' ',')

      echo "Setting envstodeploy variable..."
      echo "##vso[task.setvariable variable=envstodeploy;isOutput=true]$stepoutput"
      echo "envstodeploy is set to: $stepoutput"
    displayName: 'Determine Affected Projects'
    name: determinenxaffected
    env:
      AKS_SPN_ID: $(AKS_SPN_ID)
      AKS_SPN_KEY: $(AKS_SPN_KEY)
      TENANT_ID: $(TENANT_ID)
      AZURE_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
